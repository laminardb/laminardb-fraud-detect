name: CI

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  RUSTFLAGS: "-D warnings"

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: ${{ runner.os }}-cargo-

      - name: Build
        run: cargo build --release

      - name: Correctness tests
        run: cargo test -- --nocapture

      - name: Run headless (30s, 10% fraud rate)
        run: |
          cargo run --release -- --mode headless --fraud-rate 0.10 --duration 30 2>&1 | tee output.txt

      - name: Verify alerts generated
        run: |
          echo "## Fraud Detection Results" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat output.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

          # Check that at least 3 alert types fired
          TYPES=$(grep -cE "^  (VolumeAnomaly|PriceSpike|RapidFire|WashTrading|SuspiciousMatch):" output.txt || true)
          echo "Alert types with counts: $TYPES"
          if [ "$TYPES" -lt 3 ]; then
            echo "::error::Expected at least 3 alert types, got $TYPES"
            exit 1
          fi

      - name: Stress test (quick, 10s per level)
        run: |
          cargo run --release -- --mode stress --level-duration 10 2>&1 | tee stress_output.txt

      - name: Stress test summary
        run: |
          echo "## Stress Test Results" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat stress_output.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Criterion benchmarks
        run: |
          cargo bench 2>&1 | tee bench_output.txt

      - name: Benchmark summary
        run: |
          echo "## Criterion Benchmarks" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat bench_output.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Test summary
        if: always()
        run: |
          echo "## Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Build: passed" >> $GITHUB_STEP_SUMMARY
          echo "- Correctness tests: 6 streams + 6 edge cases verified" >> $GITHUB_STEP_SUMMARY
          echo "- Headless integration: 30s at 10% fraud rate" >> $GITHUB_STEP_SUMMARY
          echo "- Stress test: 7 load levels (10s each)" >> $GITHUB_STEP_SUMMARY
          echo "- Criterion benchmarks: push, end-to-end, pipeline setup" >> $GITHUB_STEP_SUMMARY

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sentinel - Fraud Detection Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: 'SF Mono', 'Cascadia Code', 'Fira Code', monospace; background: #0d1117; color: #c9d1d9; }
  .header { background: #161b22; border-bottom: 1px solid #30363d; padding: 12px 20px; display: flex; align-items: center; gap: 20px; }
  .header h1 { font-size: 16px; color: #58a6ff; }
  .header .stat { font-size: 13px; }
  .header .stat span { font-weight: bold; }
  .stat-alerts span { color: #f0883e; }
  .stat-trades span { color: #3fb950; }
  .stat-orders span { color: #58a6ff; }
  .stat-uptime span { color: #8b949e; }
  #connection { font-size: 11px; margin-left: auto; padding: 3px 8px; border-radius: 4px; }
  .connected { background: #238636; color: #fff; }
  .disconnected { background: #da3633; color: #fff; }

  .grid { display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: auto auto; gap: 12px; padding: 12px; }
  .panel { background: #161b22; border: 1px solid #30363d; border-radius: 6px; overflow: hidden; }
  .panel-title { font-size: 12px; font-weight: 600; color: #8b949e; padding: 8px 12px; border-bottom: 1px solid #30363d; text-transform: uppercase; letter-spacing: 0.5px; }
  .panel-body { padding: 8px 12px; }

  .alert-feed { grid-column: 1 / -1; max-height: 320px; }
  .alert-feed .panel-body { max-height: 280px; overflow-y: auto; }
  table { width: 100%; border-collapse: collapse; font-size: 12px; }
  th { text-align: left; color: #8b949e; padding: 4px 8px; border-bottom: 1px solid #30363d; font-weight: 600; }
  td { padding: 4px 8px; border-bottom: 1px solid #21262d; }
  .sev-Critical { color: #f85149; font-weight: bold; }
  .sev-High { color: #f0883e; font-weight: bold; }
  .sev-Medium { color: #58a6ff; font-weight: bold; }

  .latency-chart { min-height: 200px; }
  .latency-chart canvas { max-height: 180px; }

  .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
  .stat-row { display: flex; justify-content: space-between; padding: 3px 0; font-size: 12px; }
  .stat-row .label { color: #8b949e; }
  .stat-row .value { font-weight: bold; }
  .active { color: #3fb950; }
  .inactive { color: #f85149; }

  .count-bar { display: flex; align-items: center; gap: 8px; padding: 3px 0; font-size: 12px; }
  .count-bar .bar { height: 6px; background: #f0883e; border-radius: 3px; min-width: 2px; transition: width 0.3s; }
  .count-bar .name { width: 130px; color: #8b949e; }
  .count-bar .num { width: 50px; text-align: right; font-weight: bold; }

  .price-row { display: flex; justify-content: space-between; padding: 3px 0; font-size: 12px; }
  .price-row .sym { font-weight: bold; color: #fff; }

  .latency-table { font-size: 12px; }
  .latency-table td { padding: 2px 6px; }
  .latency-table .stage { color: #8b949e; width: 70px; }
</style>
</head>
<body>

<div class="header">
  <h1>Sentinel</h1>
  <div class="stat stat-alerts">Alerts: <span id="totalAlerts">0</span></div>
  <div class="stat stat-trades">Trades: <span id="totalTrades">0</span></div>
  <div class="stat stat-orders">Orders: <span id="totalOrders">0</span></div>
  <div class="stat stat-uptime">Uptime: <span id="uptime">0s</span></div>
  <div id="connection" class="disconnected">Disconnected</div>
</div>

<div class="grid">
  <!-- Alert Feed -->
  <div class="panel alert-feed">
    <div class="panel-title">Alert Feed</div>
    <div class="panel-body">
      <table>
        <thead><tr><th>SEV</th><th>TYPE</th><th>DESCRIPTION</th><th>LATENCY</th></tr></thead>
        <tbody id="alertBody"></tbody>
      </table>
    </div>
  </div>

  <!-- Latency Chart -->
  <div class="panel latency-chart">
    <div class="panel-title">Latency (us)</div>
    <div class="panel-body">
      <canvas id="latencyChart"></canvas>
      <table class="latency-table" style="margin-top:8px">
        <tr><td class="stage">Push</td><td id="pushP50">-</td><td id="pushP95">-</td><td id="pushP99">-</td></tr>
        <tr><td class="stage">Proc</td><td id="procP50">-</td><td id="procP95">-</td><td id="procP99">-</td></tr>
        <tr><td class="stage">Alert</td><td id="alertP50">-</td><td id="alertP95">-</td><td id="alertP99">-</td></tr>
        <tr><td></td><td style="color:#8b949e">p50</td><td style="color:#8b949e">p95</td><td style="color:#8b949e">p99</td></tr>
      </table>
    </div>
  </div>

  <!-- Streams + Prices -->
  <div class="panel">
    <div class="panel-title">Detection Streams</div>
    <div class="panel-body" id="streamPanel"></div>
    <div class="panel-title" style="margin-top:4px">Symbol Prices</div>
    <div class="panel-body" id="pricePanel"></div>
  </div>

  <!-- Alert Counts -->
  <div class="panel">
    <div class="panel-title">Alert Counts</div>
    <div class="panel-body" id="countPanel"></div>
  </div>

  <!-- Right: additional stats -->
  <div class="panel">
    <div class="panel-title">Alert Counts by Type</div>
    <div class="panel-body">
      <canvas id="countChart"></canvas>
    </div>
  </div>
</div>

<script>
const MAX_ALERTS = 200;
const MAX_LATENCY_POINTS = 60;
let alerts = [];

// Latency chart
const latencyCtx = document.getElementById('latencyChart').getContext('2d');
const latencyChart = new Chart(latencyCtx, {
  type: 'line',
  data: {
    labels: [],
    datasets: [
      { label: 'Push p50', data: [], borderColor: '#3fb950', borderWidth: 1.5, pointRadius: 0, tension: 0.3 },
      { label: 'Proc p50', data: [], borderColor: '#58a6ff', borderWidth: 1.5, pointRadius: 0, tension: 0.3 },
      { label: 'Alert p50', data: [], borderColor: '#f0883e', borderWidth: 1.5, pointRadius: 0, tension: 0.3 },
    ]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    animation: false,
    scales: {
      x: { display: false },
      y: { beginAtZero: true, ticks: { color: '#8b949e', font: { size: 10 } }, grid: { color: '#21262d' } }
    },
    plugins: { legend: { labels: { color: '#8b949e', font: { size: 10 } } } }
  }
});

// Alert counts doughnut
const countCtx = document.getElementById('countChart').getContext('2d');
const countChart = new Chart(countCtx, {
  type: 'doughnut',
  data: {
    labels: ['VolumeAnomaly', 'PriceSpike', 'RapidFire', 'WashTrading', 'SuspiciousMatch'],
    datasets: [{ data: [0, 0, 0, 0, 0], backgroundColor: ['#f0883e', '#f85149', '#a371f7', '#58a6ff', '#3fb950'] }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: true,
    animation: false,
    plugins: { legend: { position: 'bottom', labels: { color: '#8b949e', font: { size: 10 } } } }
  }
});

let tickCount = 0;

function connect() {
  const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
  const ws = new WebSocket(`${proto}//${location.host}/ws`);
  const connEl = document.getElementById('connection');

  ws.onopen = () => { connEl.textContent = 'Connected'; connEl.className = 'connected'; };
  ws.onclose = () => { connEl.textContent = 'Disconnected'; connEl.className = 'disconnected'; setTimeout(connect, 2000); };
  ws.onerror = () => ws.close();

  ws.onmessage = (e) => {
    const d = JSON.parse(e.data);
    tickCount++;

    // Header stats
    document.getElementById('totalAlerts').textContent = d.total_alerts;
    document.getElementById('totalTrades').textContent = d.total_trades;
    document.getElementById('totalOrders').textContent = d.total_orders;
    document.getElementById('uptime').textContent = d.uptime_secs + 's';

    // Alerts
    for (const a of d.alerts) {
      alerts.unshift(a);
    }
    if (alerts.length > MAX_ALERTS) alerts.length = MAX_ALERTS;
    renderAlerts();

    // Latency chart
    latencyChart.data.labels.push(tickCount);
    latencyChart.data.datasets[0].data.push(d.latency.push.p50_us);
    latencyChart.data.datasets[1].data.push(d.latency.processing.p50_us);
    latencyChart.data.datasets[2].data.push(d.latency.alert.p50_us);
    if (latencyChart.data.labels.length > MAX_LATENCY_POINTS) {
      latencyChart.data.labels.shift();
      latencyChart.data.datasets.forEach(ds => ds.data.shift());
    }
    latencyChart.update();

    // Latency table
    document.getElementById('pushP50').textContent = d.latency.push.p50_us;
    document.getElementById('pushP95').textContent = d.latency.push.p95_us;
    document.getElementById('pushP99').textContent = d.latency.push.p99_us;
    document.getElementById('procP50').textContent = d.latency.processing.p50_us;
    document.getElementById('procP95').textContent = d.latency.processing.p95_us;
    document.getElementById('procP99').textContent = d.latency.processing.p99_us;
    document.getElementById('alertP50').textContent = d.latency.alert.p50_us;
    document.getElementById('alertP95').textContent = d.latency.alert.p95_us;
    document.getElementById('alertP99').textContent = d.latency.alert.p99_us;

    // Streams
    let streamHtml = '';
    for (const s of d.streams) {
      const cls = s.active ? 'active' : 'inactive';
      const label = s.active ? 'OK' : 'WAIT';
      streamHtml += `<div class="stat-row"><span class="label">${s.name}</span><span class="${cls}">${label} (${s.count})</span></div>`;
    }
    document.getElementById('streamPanel').innerHTML = streamHtml;

    // Prices
    let priceHtml = '';
    const sorted = Object.entries(d.prices).sort((a, b) => a[0].localeCompare(b[0]));
    for (const [sym, price] of sorted) {
      priceHtml += `<div class="price-row"><span class="sym">${sym}</span><span>${price.toFixed(2)}</span></div>`;
    }
    document.getElementById('pricePanel').innerHTML = priceHtml;

    // Alert counts bar
    const types = ['VolumeAnomaly', 'PriceSpike', 'RapidFire', 'WashTrading', 'SuspiciousMatch'];
    const counts = types.map(t => d.alert_counts[t] || 0);
    const maxCount = Math.max(...counts, 1);
    let countHtml = '';
    for (let i = 0; i < types.length; i++) {
      const pct = (counts[i] / maxCount * 100).toFixed(0);
      countHtml += `<div class="count-bar"><span class="name">${types[i]}</span><div class="bar" style="width:${pct}%"></div><span class="num">${counts[i]}</span></div>`;
    }
    document.getElementById('countPanel').innerHTML = countHtml;

    // Doughnut
    countChart.data.datasets[0].data = counts;
    countChart.update();
  };
}

function renderAlerts() {
  const body = document.getElementById('alertBody');
  let html = '';
  for (const a of alerts.slice(0, 100)) {
    html += `<tr>
      <td class="sev-${a.severity}">${a.severity === 'Critical' ? 'CRIT' : a.severity === 'High' ? 'HIGH' : ' MED'}</td>
      <td>${a.alert_type}</td>
      <td>${a.description}</td>
      <td>${a.latency_us}us</td>
    </tr>`;
  }
  body.innerHTML = html;
}

connect();
</script>
</body>
</html>
